<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset - Teams FC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #304243;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #131c1d;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }
        .logo {
            color: #e5d993;
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .message {
            margin-bottom: 1rem;
        }
        .button {
            background-color: #e5d993;
            color: black;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
        }
        .button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Teams FC</div>
        <div class="message">
            <h2>Password Reset</h2>
            <p>Click the button below to open the Teams FC app and complete your password reset.</p>
        </div>
        
        <button class="button" onclick="openApp()">Open Teams FC App</button>
    </div>

    <script>
        // Extract tokens from URL
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const expiresAt = urlParams.get('expires_at');
        const expiresIn = urlParams.get('expires_in');
        const tokenType = urlParams.get('token_type');
        const type = urlParams.get('type');

        console.log('Tokens extracted:', { accessToken, refreshToken, expiresAt, expiresIn, tokenType, type });

        function openApp() {
            // Construct the deep link with all the necessary parameters
            const deepLink = `teamsfc2://(auth)/(screens)/reset-password?access_token=${accessToken}&refresh_token=${refreshToken}&expires_at=${expiresAt}&expires_in=${expiresIn}&token_type=${tokenType}&type=${type}`;
            
            console.log('Attempting to open deep link:', deepLink);
            
            // Try multiple methods to open the app
            try {
                // Method 1: Create and click a link (most reliable)
                const link = document.createElement('a');
                link.href = deepLink;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Method 2: Direct location change (fallback)
                setTimeout(() => {
                    window.location.href = deepLink;
                }, 100);
                
                // Method 3: Use window.open (another fallback)
                setTimeout(() => {
                    window.open(deepLink, '_self');
                }, 200);
                
                // Method 4: Try with iframe (iOS fallback)
                setTimeout(() => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = deepLink;
                    document.body.appendChild(iframe);
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);
                }, 300);
                
            } catch (error) {
                console.error('Error opening deep link:', error);
            }
            
            // Show fallback message after a longer delay
            setTimeout(() => {
                const fallbackMessage = `If the Teams FC app didn't open automatically, please:\n\n1. Copy the reset link below\n2. Open the Teams FC app manually\n3. Paste the link in your browser\n\nDeep link: ${deepLink}`;
                alert(fallbackMessage);
            }, 3000);
        }

        function copyLink() {
            const deepLink = `teamsfc2://(auth)/(screens)/reset-password?access_token=${accessToken}&refresh_token=${refreshToken}&expires_at=${expiresAt}&expires_in=${expiresIn}&token_type=${tokenType}&type=${type}`;
            
            navigator.clipboard.writeText(deepLink).then(() => {
                alert('Reset link copied to clipboard!\n\nYou can now:\n1. Open the Teams FC app manually\n2. Paste this link in your browser\n3. Or share it to open the app');
            }).catch(() => {
                alert('Could not copy to clipboard. Please manually copy this link:\n\n' + deepLink);
            });
        }

        function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Please enter both password fields.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Resetting...';
            button.disabled = true;
            
            // For now, show success message and provide instructions
            // The actual password reset will be handled by the app
            setTimeout(() => {
                alert('Password reset link received!\n\nPlease open the Teams FC app to complete your password reset.\n\nThe app will use the recovery tokens to update your password.');
                
                // Try to open the app with the deep link
                openApp();
            }, 1000);
            
            button.textContent = originalText;
            button.disabled = false;
        }

        function debugInfo() {
            const debugInfo = `
Current URL: ${window.location.href}
Hash: ${window.location.hash}
Access Token: ${accessToken ? 'Present' : 'Missing'}
Refresh Token: ${refreshToken ? 'Present' : 'Missing'}
Expires At: ${expiresAt}
Expires In: ${expiresIn}
Token Type: ${tokenType}
Type: ${type}
Deep Link: teamsfc2://(auth)/(screens)/reset-password?access_token=${accessToken}&refresh_token=${refreshToken}&expires_at=${expiresAt}&expires_in=${expiresIn}&token_type=${tokenType}&type=${type}
            `;
            alert(debugInfo);
        }

        function showSimulatorInstructions() {
            const deepLink = `teamsfc2://(auth)/(screens)/reset-password?access_token=${accessToken}&refresh_token=${refreshToken}&expires_at=${expiresAt}&expires_in=${expiresIn}&token_type=${tokenType}&type=${type}`;
            
            const instructions = `
SIMULATOR TESTING INSTRUCTIONS:

Since you're testing on a simulator, the deep link won't work from the browser.

To test the deep link:

1. Copy this deep link:
${deepLink}

2. For iOS Simulator, run this command in Terminal:
xcrun simctl openurl booted "${deepLink}"

3. For Android Emulator, run this command in Terminal:
adb shell am start -W -a android.intent.action.VIEW -d "${deepLink}" com.teamsfc.app

4. Or test on a physical device where the app is installed.

The deep link should open your app and navigate to the password reset page.
            `;
            alert(instructions);
        }

        // Auto-attempt to open app after a short delay
        setTimeout(() => {
            openApp();
        }, 1000);
    </script>
</body>
</html> 