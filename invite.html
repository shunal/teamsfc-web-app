<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accept Invitation - TeamsFC</title>
    <meta name="apple-itunes-app" content="app-id=YOUR_APP_ID">
    <meta name="google-play-app" content="app-id=com.teamsfc.app">
    <link rel="apple-touch-icon" href="/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #304243 0%, #202e2f 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            max-width: 500px;
            background: #202e2f;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid #e5d993;
        }
        
        .logo {
            max-width: 200px;
            margin: 0 auto 30px;
            display: block;
        }
        
        h1 {
            color: #e5d993;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .invitation-details {
            background: #131c1d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .invitation-details p {
            margin: 10px 0;
            color: #bfbfbf;
        }
        
        .invitation-details strong {
            color: #e5d993;
        }
        
        p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #bfbfbf;
        }
        
        .button {
            display: inline-block;
            background-color: #e5d993;
            color: #304243;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            margin: 10px 5px;
            transition: opacity 0.3s;
            border: none;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        
        .button:hover {
            opacity: 0.9;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background-color: transparent;
            color: #e5d993;
            border: 1px solid #e5d993;
        }
        
        .spinner {
            border: 3px solid #3a4a4b;
            border-top: 3px solid #e5d993;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        .spinner.active {
            display: block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        .app-banner {
            background: #131c1d;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-banner-text {
            text-align: left;
            flex: 1;
        }
        
        .app-banner-text strong {
            color: #e5d993;
            display: block;
            margin-bottom: 5px;
        }
        
        .app-banner-button {
            background: #e5d993;
            color: #304243;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
            margin-left: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="/logo.png" alt="TeamsFC" class="logo" onerror="this.style.display='none'">
        <h1 id="title">Accept Invitation</h1>
        <div id="loadingState">
            <p>Loading invitation details...</p>
            <div class="spinner active"></div>
        </div>
        
        <div id="invitationState" style="display: none;">
            <div class="invitation-details">
                <p><strong>Invited by:</strong> <span id="inviterName">Loading...</span></p>
                <p><strong>Type:</strong> <span id="invitationType">Loading...</span></p>
                <p id="teamOrOrgInfo" style="display: none;"><strong id="teamOrOrgLabel">Team:</strong> <span id="teamOrOrgName">Loading...</span></p>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            
            <div id="loggedInActions" style="display: none;">
                <button class="button" id="acceptButton" onclick="acceptInvitation()">Accept Invitation</button>
                <button class="button button-secondary" onclick="declineInvitation()">Decline</button>
            </div>
            
            <div id="loggedOutActions" style="display: none;">
                <p>Please sign up or log in to accept this invitation.</p>
                <a href="#" class="button" id="signupButton">Sign Up</a>
                <a href="#" class="button button-secondary" id="loginButton">Log In</a>
            </div>
        </div>
        
        <div id="appBanner" class="app-banner" style="display: none;">
            <div class="app-banner-text">
                <strong>Get the TeamsFC App</strong>
                <span style="font-size: 14px;">For the best experience</span>
            </div>
            <a href="#" id="downloadAppButton" class="app-banner-button">Download</a>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://hoibjaixenxvulkksaep.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhvaWJqYWl4ZW54dnVsa2tzYWVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTA5NTM1MzQsImV4cCI6MjAyNjUyOTUzNH0.95F8G3ffPAya2e8yGe3c1CB0HzSbAYcHf8IagiTuyWo';
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        let invitationData = null;
        let isLoggedIn = false;
        
        // Check if Supabase is loaded
        if (!window.supabase) {
            // Load Supabase from CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.onload = () => {
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                loadInvitation();
            };
            document.head.appendChild(script);
        } else {
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
        
        // Detect if app is installed (Universal Links will handle this automatically)
        // For fallback, we'll show web-based acceptance
        
        async function loadInvitation() {
            if (!token) {
                showError('No invitation token found. Please check your email link.');
                return;
            }
            
            try {
                // Call Supabase to get invitation details
                const response = await fetch(`${SUPABASE_URL}/rest/v1/invitations?invitation_token=eq.${token}&select=*,inviter:inviter_id(first_name,last_name),organization:organization_id(name),team:team_id(name)`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load invitation');
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    showError('Invalid or expired invitation.');
                    return;
                }
                
                invitationData = data[0];
                
                // Check if expired
                if (new Date(invitationData.expires_at) < new Date()) {
                    showError('This invitation has expired.');
                    return;
                }
                
                // Check if already accepted
                if (invitationData.status === 'accepted') {
                    showError('This invitation has already been accepted.');
                    return;
                }
                
                // Display invitation details
                displayInvitation(invitationData);
                
            } catch (error) {
                console.error('Error loading invitation:', error);
                showError('Failed to load invitation. Please try again.');
            }
        }
        
        function displayInvitation(invitation) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('invitationState').style.display = 'block';
            
            const inviterName = invitation.inviter 
                ? `${invitation.inviter.first_name} ${invitation.inviter.last_name}`
                : 'Someone';
            
            document.getElementById('inviterName').textContent = inviterName;
            
            let typeText = '';
            let teamOrOrgName = '';
            let teamOrOrgLabel = '';
            
            switch (invitation.invitation_type) {
                case 'org_to_coach':
                    typeText = 'Join as Coach';
                    teamOrOrgName = invitation.organization?.name || 'an organization';
                    teamOrOrgLabel = 'Organization';
                    break;
                case 'coach_to_player':
                case 'org_to_player':
                    typeText = 'Join as Player';
                    teamOrOrgName = invitation.team?.name || 'a team';
                    teamOrOrgLabel = 'Team';
                    break;
            }
            
            document.getElementById('invitationType').textContent = typeText;
            document.getElementById('teamOrOrgLabel').textContent = teamOrOrgLabel;
            document.getElementById('teamOrOrgName').textContent = teamOrOrgName;
            document.getElementById('teamOrOrgInfo').style.display = 'block';
            
            // Check if user is logged in (you'd implement this with Supabase auth)
            // For now, show logged out actions
            checkAuthStatus();
        }
        
        async function checkAuthStatus() {
            if (!window.supabaseClient) {
                // Supabase not loaded yet, show logged out state
                showLoggedOutState();
                return;
            }
            
            try {
                // Check if user has a session
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                isLoggedIn = !!session;
                
                if (isLoggedIn) {
                    document.getElementById('loggedInActions').style.display = 'block';
                    document.getElementById('loggedOutActions').style.display = 'none';
                } else {
                    showLoggedOutState();
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                showLoggedOutState();
            }
        }
        
        function showLoggedOutState() {
            document.getElementById('loggedInActions').style.display = 'none';
            document.getElementById('loggedOutActions').style.display = 'block';
            
            // Set up signup/login links
            const signupUrl = `/signup.html?invitationToken=${token}`;
            const loginUrl = `/login.html?invitationToken=${token}`;
            
            document.getElementById('signupButton').href = signupUrl;
            document.getElementById('loginButton').href = loginUrl;
        }
        
        async function acceptInvitation() {
            if (!invitationData || !token) return;
            
            if (!window.supabaseClient) {
                showError('Please sign up or log in first.');
                return;
            }
            
            const button = document.getElementById('acceptButton');
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Processing...';
            document.querySelector('.spinner').classList.add('active');
            
            try {
                // Get auth token
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    throw new Error('Not authenticated. Please log in first.');
                }
                
                // Call Supabase Edge Function to accept invitation
                const response = await fetch(`${SUPABASE_URL}/functions/v1/accept-invitation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ token })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to accept invitation');
                }
                
                showSuccess('Invitation accepted! Opening app...');
                
                // Redirect to app using deep link (like Stripe checkout)
                setTimeout(() => {
                    window.location.href = `teamsfc2://invite/accept?token=${token}`;
                    
                    // If app doesn't open, show download banner after 2 seconds
                    setTimeout(() => {
                        document.getElementById('appBanner').style.display = 'block';
                    }, 2000);
                }, 1000);
                
            } catch (error) {
                console.error('Error accepting invitation:', error);
                showError(error.message || 'Failed to accept invitation. Please try again.');
                button.disabled = false;
                button.textContent = 'Accept Invitation';
                document.querySelector('.spinner').classList.remove('active');
            }
        }
        
        function declineInvitation() {
            window.location.href = 'https://teamsfc.com';
        }
        
        function tryOpenApp() {
            // Try Universal Link first (will open app if installed)
            const universalLink = `https://teamsfc.com/invite?token=${token}`;
            
            // Try deep link as fallback
            const deepLink = `teamsfc2://invite?token=${token}`;
            
            // Try Universal Link
            window.location.href = universalLink;
            
            // If still here after 2 seconds, show app download banner
            setTimeout(() => {
                document.getElementById('appBanner').style.display = 'flex';
                document.getElementById('downloadAppButton').href = getAppStoreLink();
            }, 2000);
        }
        
        function getAppStoreLink() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return 'https://apps.apple.com/app/teamsfc/idYOUR_APP_ID'; // Replace with actual App Store ID
            } else if (/android/i.test(userAgent)) {
                return 'https://play.google.com/store/apps/details?id=com.teamsfc.app';
            }
            
            return 'https://teamsfc.com/download';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            document.getElementById('loadingState').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');
        }
        
        // Load invitation on page load
        if (token) {
            // Wait a bit for Supabase to load if needed
            if (!window.supabase) {
                setTimeout(() => {
                    loadInvitation();
                }, 500);
            } else {
                loadInvitation();
            }
        } else {
            showError('No invitation token found.');
        }
        
        // Universal Links will automatically open the app if installed
        // Otherwise, this page will be shown for web-based acceptance
    </script>
</body>
</html>
